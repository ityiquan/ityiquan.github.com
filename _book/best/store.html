
<!DOCTYPE HTML>
<html lang="zh" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>定义 stores · 前端知识点总结</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-disqus/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-prism/prism.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-splitter/splitter.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="actions.html" />
    
    
    <link rel="prev" href="pitfalls.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="輸入並搜尋" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../MobX.html">
            
                <a href="../MobX.html">
            
                    
                    MobX
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" >
            
                <span>
            
                    
                    介绍
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="../intro/overview.html">
            
                <a href="../intro/overview.html">
            
                    
                    MobX 要点
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="../intro/concepts.html">
            
                <a href="../intro/concepts.html">
            
                    
                    概念 & 原则
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../refguide/api.html">
            
                <a href="../refguide/api.html">
            
                    
                    API 概述
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="../refguide/observable.html">
            
                <a href="../refguide/observable.html">
            
                    
                    observable
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="../refguide/observable-decorator.html">
            
                <a href="../refguide/observable-decorator.html">
            
                    
                    @observable
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3" data-path="../refguide/computed-decorator.html">
            
                <a href="../refguide/computed-decorator.html">
            
                    
                    (@)computed
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.4" data-path="../refguide/autorun.html">
            
                <a href="../refguide/autorun.html">
            
                    
                    autorun
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.5" data-path="../refguide/observer-component.html">
            
                <a href="../refguide/observer-component.html">
            
                    
                    (@)observer
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.6" data-path="../refguide/action.html">
            
                <a href="../refguide/action.html">
            
                    
                    action
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" >
            
                <span>
            
                    
                    Observable 类型
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="../refguide/object.html">
            
                <a href="../refguide/object.html">
            
                    
                    对象
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="../refguide/array.html">
            
                <a href="../refguide/array.html">
            
                    
                    数组
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.3" data-path="../refguide/map.html">
            
                <a href="../refguide/map.html">
            
                    
                    maps
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.4" data-path="../refguide/boxed.html">
            
                <a href="../refguide/boxed.html">
            
                    
                    boxed values
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="react.html">
            
                <a href="react.html">
            
                    
                    理解MobX是如何响应的
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="decorators.html">
            
                <a href="decorators.html">
            
                    
                    如何（不）使用装饰符
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="../资料.html">
            
                <a href="../资料.html">
            
                    
                    资料
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.1" data-path="../faq/blogs.html">
            
                <a href="../faq/blogs.html">
            
                    
                    教程，视频和博客
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2" data-path="../faq/related.html">
            
                <a href="../faq/related.html">
            
                    
                    相关项目
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.3" data-path="../faq/examples.html">
            
                <a href="../faq/examples.html">
            
                    
                    示例项目
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.4" data-path="../faq/boilerplates.html">
            
                <a href="../faq/boilerplates.html">
            
                    
                    样板
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.5" data-path="../faq/faq.html">
            
                <a href="../faq/faq.html">
            
                    
                    常见问题
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="../注意点--技巧.html">
            
                <a href="../注意点--技巧.html">
            
                    
                    注意点 & 技巧
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.9.1" data-path="pitfalls.html">
            
                <a href="pitfalls.html">
            
                    
                    常见问题 & 最佳事件
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.9.2" data-path="store.html">
            
                <a href="store.html">
            
                    
                    定义 stores
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.3" data-path="actions.html">
            
                <a href="actions.html">
            
                    
                    创建（异步）actions
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.4" data-path="react-performance.html">
            
                <a href="react-performance.html">
            
                    
                    优化 React 组件
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.5" data-path="devtools.html">
            
                <a href="devtools.html">
            
                    
                    开发者工具
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.6" data-path="syntax.html">
            
                <a href="syntax.html">
            
                    
                    ES5 \/ ES6 \/ TypeScript 语法
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.7" data-path="stateless-HMR.html">
            
                <a href="stateless-HMR.html">
            
                    
                    无状态组件和热加载
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.10" >
            
                <span>
            
                    
                    实用方法
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.1" data-path="../refguide/autorun-async.html">
            
                <a href="../refguide/autorun-async.html">
            
                    
                    autorunAsync
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.2" data-path="../refguide/extending.html">
            
                <a href="../refguide/extending.html">
            
                    
                    Atom & Reaction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.3" data-path="../refguide/create-transformer.html">
            
                <a href="../refguide/create-transformer.html">
            
                    
                    createTransformer
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.4" data-path="../refguide/expr.html">
            
                <a href="../refguide/expr.html">
            
                    
                    expr
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.5" data-path="../refguide/extend-observable.html">
            
                <a href="../refguide/extend-observable.html">
            
                    
                    extendObservable
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.6" data-path="../refguide/is-observable.html">
            
                <a href="../refguide/is-observable.html">
            
                    
                    isObservable
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.7" data-path="../refguide/modifiers.html">
            
                <a href="../refguide/modifiers.html">
            
                    
                    modifiers
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.8" data-path="../refguide/observe.html">
            
                <a href="../refguide/observe.html">
            
                    
                    intercept & observe
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.9" data-path="../refguide/reaction.html">
            
                <a href="../refguide/reaction.html">
            
                    
                    reaction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.10" data-path="../refguide/spy.html">
            
                <a href="../refguide/spy.html">
            
                    
                    spy
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.11" data-path="../refguide/tojson.html">
            
                <a href="../refguide/tojson.html">
            
                    
                    toJS
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.12" data-path="../refguide/transaction.html">
            
                <a href="../refguide/transaction.html">
            
                    
                    transaction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.13" data-path="../refguide/untracked.html">
            
                <a href="../refguide/untracked.html">
            
                    
                    untracked
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.14" data-path="../refguide/when.html">
            
                <a href="../refguide/when.html">
            
                    
                    when
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            本書使用 GitBook 釋出
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >定义 stores</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="best-practices-for-building-large-scale-maintainable-projects">Best Practices for building large scale maintainable projects</h1>
<p>This section contains some best practices we discovered at Mendix while working with MobX.
This section is opinionated and you are in no way forced to apply these practices.
There are many ways of working with MobX and React, and this is just one of them.</p>
<h1 id="stores">Stores</h1>
<p>Let&apos;s start with <em>stores</em>.
In the next sections we will discuss <em>actions</em> and React <em>components</em> as well.
Stores can be found in any Flux architecture and can be compared a bit with controllers in the MVC pattern.
The main responsibility of stores is to move <em>logic</em> and <em>state</em> out of your components into a standalone testable unit that can be used in both frontend and backend JavaScript.</p>
<h2 id="stores-for-the-user-interface-state">Stores for the user interface state</h2>
<p>Most applications benefit from having at least two stores.
One for the <em>UI state</em> and one or more for the <em>domain state</em>.
The advantage of separating those two is you can reuse and test <em>domain state</em> universally, and you might very well reuse it in other applications.
The <em>ui-state-store</em> however is often very specific for your application.
But usually very simple as well.
This store typically doesn&apos;t have much logic in it, but will store a plethora of loosely coupled pieces of information about the UI.
This is ideal as most applications will change the UI state often during the development process.</p>
<p>Things you will typically find in UI stores:</p>
<ul>
<li>Session information</li>
<li>Information about how far your application has loaded</li>
<li>Information that will not be stored in the backend</li>
<li>Information that affects the UI globally<ul>
<li>Window dimensions</li>
<li>Accessibility information</li>
<li>Current language</li>
<li>Currently active theme</li>
</ul>
</li>
<li>User interface state as soon as it effects multiple, further unrelated components:<ul>
<li>Current selection</li>
<li>Visibility of toolbars, etc.</li>
<li>State of a wizard</li>
<li>State of a global overlay</li>
</ul>
</li>
</ul>
<p>It might very well be that these pieces of information start as internal state of a specific component (for example the visibility of a toolbar).
But after a while you discover that you need this information somewhere else in your application.
Instead of pushing state in such a case upwards in the component tree, like you would do in plain React apps, you just move that state to the <em>ui-state-store</em>.</p>
<p>Make sure this state is a singleton.
For isomorphic applications you might also want to provide a stub implementation of this store with sane defaults so that all components render as expected.
You might distribute the <em>ui-state-store</em> through your application by passing it as a property through your component tree.
You can also pass this store by using context or make it globally available as a module.
For testing purposes, I recommend to just pass it through the component tree.</p>
<p>Example of a store (using ES6 syntax):</p>
<pre class="language-"><code class="lang-javascript"><span class="token keyword">import</span> <span class="token punctuation">{</span>observable<span class="token punctuation">,</span> computed<span class="token punctuation">,</span> asStructure<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&apos;mobx&apos;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> jquery <span class="token keyword">from</span> <span class="token string">&apos;jquery&apos;</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">UiState</span> <span class="token punctuation">{</span>
    @observable language <span class="token operator">=</span> <span class="token string">&quot;en_US&quot;</span><span class="token punctuation">;</span>
    @observable pendingRequestCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// asStructure makes sure observer won&apos;t be signaled only if the</span>
    <span class="token comment" spellcheck="true">// dimensions object changed in a deepEqual manner</span>
    @observable windowDimensions <span class="token operator">=</span> <span class="token function">asStructure</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        width<span class="token punctuation">:</span> <span class="token function">jquery</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">width</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        height<span class="token punctuation">:</span> <span class="token function">jquery</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">height</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        jquery<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>windowDimensions <span class="token operator">=</span> <span class="token function">getWindowDimensions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    @computed <span class="token keyword">get</span> <span class="token function">appIsInSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pendingRequestCount <span class="token operator">===</span> <span class="token number">0</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

singleton <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UiState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> singleton<span class="token punctuation">;</span>
</code></pre>
<h2 id="domain-stores">Domain Stores</h2>
<p>Your application will contain one or multiple <em>domain</em> stores.
These stores store the data your application is all about.
Todo items, users, books, movies, orders, you name it.
Your application will most probably have at least one domain store.</p>
<p>A single domain store should be responsible for a single concept in your application.
However a single concept might take the form of multiple subtypes and it is often a (cyclic) tree structure.
For example: one domain store for your products, and one for our orders and orderlines.
As a rule of thumb: if the nature of the relationship between two items is containment, they should typically be in the same store.
So a store just manages <em>domain objects</em>.</p>
<p>These are the responsibility of a store:</p>
<ul>
<li>Instantiate domain objects. Make sure domain objects know the store they belong to.</li>
<li>Make sure there is only one instance of each of your domain objects.
The same user, order or todo should not be twice in your memory.
This way you can safely use references and also be sure you are looking at the latest instance, without ever having to resolve a reference.
This is fast, straightforward and convenient when debugging.</li>
<li>Provide backend integration. Store data when needed.</li>
<li>Update existing instances if updates are received from the backend.</li>
<li>Provide a stand-alone, universal, testable component of your application.</li>
<li>To make sure your store is testable and can be run server-side, you probably will move doing actual websocket / http requests to a separate object so that you can abstract over your communication layer.</li>
<li>There should be only one instance of a store.</li>
</ul>
<h3 id="domain-objects">Domain objects</h3>
<p>Each domain object should be expressed using its own class (or constructor function).
It is recommended to store your data in <em>denormalized</em> form.
There is no need to treat your client-side application state as some kind of database.
Real references, cyclic data structures and instance methods are powerful concepts in JavaScript.
Domain objects are allowed to refer directly to domain objects from other stores.
Remember: we want to keep our actions and views as simple as possible and needing to manage references and doing garbage collection yourself might be a step backward.
Unlike many Flux architectures, with MobX there is no need to normalize your data, and this makes it a lot simpler to build the <em>essentially</em> complex parts of your application:
your business rules, actions and user interface.</p>
<p>Domain objects can delegate all their logic to the store they belong to if that suits your application well.
It is possible to express your domain objects as plain objects, but classes have some important advantages over plain objects:</p>
<ul>
<li>They can have methods.
This makes your domain concepts easier to use stand-alone and reduces the amount of contextual awareness that is needed in your application.
Just pass objects around.
You don&apos;t have to pass stores around, or have to figure out which actions can be applied to an object if they are just available as instance methods.
Especially in large applications this is important.</li>
<li>They offer fine grained control over the visibility of attributes and methods.</li>
<li>Objects created using a constructor function can freely mix observable properties and functions, and non-observable properties and methods.</li>
<li>They are easily recognizable and can strictly be type-checked.</li>
</ul>
<h3 id="example-domain-store">Example domain store</h3>
<pre class="language-"><code class="lang-javascript"><span class="token keyword">import</span> <span class="token punctuation">{</span>observable<span class="token punctuation">,</span> autorun<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&apos;mobx&apos;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> uuid <span class="token keyword">from</span> <span class="token string">&apos;node-uuid&apos;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">TodoStore</span> <span class="token punctuation">{</span>
    authorStore<span class="token punctuation">;</span>
    transportLayer<span class="token punctuation">;</span>
    @observable todos <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    @observable isLoading <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token function">constructor</span><span class="token punctuation">(</span>transportLayer<span class="token punctuation">,</span> authorStore<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>authorStore <span class="token operator">=</span> authorStore<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Store that can resolve authors for us</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>transportLayer <span class="token operator">=</span> transportLayer<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Thing that can make server requests for us</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>transportLayer<span class="token punctuation">.</span><span class="token function">onReceiveTodoUpdate</span><span class="token punctuation">(</span>updatedTodo <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateTodoFromServer</span><span class="token punctuation">(</span>updatedTodo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">loadTodos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/**
     * Fetches all todo&apos;s from the server
     */</span>
    <span class="token function">loadTodos</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>isLoading <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>transportLayer<span class="token punctuation">.</span><span class="token function">fetchTodos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>fetchedTodos <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
            fetchedTodos<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>json <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateTodoFromServer</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>isLoading <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/**
     * Update a todo with information from the server. Guarantees a todo
     * only exists once. Might either construct a new todo, update an existing one,
     * or remove an todo if it has been deleted on the server.
     */</span>
    <span class="token function">updateTodoFromServer</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> todo <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>todos<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>todo <span class="token operator">=</span><span class="token operator">&gt;</span> todo<span class="token punctuation">.</span>id <span class="token operator">===</span> json<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>todo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            todo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Todo</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> json<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>todos<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>todo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>json<span class="token punctuation">.</span>isDeleted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">removeTodo</span><span class="token punctuation">(</span>todo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            todo<span class="token punctuation">.</span><span class="token function">updateFromJson</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/**
     * Creates a fresh todo on the client and server
     */</span>
    <span class="token function">createTodo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> todo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Todo</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>todos<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>todo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> todo<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/**
     * A todo was somehow deleted, clean it from the client memory
     */</span>
    <span class="token function">removeTodo</span><span class="token punctuation">(</span>todo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>todos<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>todos<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>todo<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        todo<span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Todo</span> <span class="token punctuation">{</span>

    <span class="token comment" spellcheck="true">/**
     * unique id of this todo, immutable.
     */</span>
    id <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    @observable completed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    @observable task <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/**
     * reference to an Author object (from the authorStore)
     */</span>
    @observable author <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    store <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/**
     * Indicates whether changes in this object
     * should be submitted to the server
     */</span>
    autoSave <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/**
     * Disposer for the side effect that automatically
     * stores this Todo, see @dispose.
     */</span>
    saveHandler <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token function">constructor</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> id<span class="token operator">=</span>uuid<span class="token punctuation">.</span><span class="token function">v4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>store <span class="token operator">=</span> store<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>saveHandler <span class="token operator">=</span> <span class="token function">reaction</span><span class="token punctuation">(</span>
            <span class="token comment" spellcheck="true">// observe everything that is used in the JSON:</span>
            <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>asJson<span class="token punctuation">,</span>
            <span class="token comment" spellcheck="true">// if autoSave is on, send json to server</span>
            <span class="token punctuation">(</span>json<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>autoSave<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>store<span class="token punctuation">.</span>transportLayer<span class="token punctuation">.</span><span class="token function">saveTodo</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/**
     * Remove this todo from the client and server
     */</span>
    <span class="token keyword">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>store<span class="token punctuation">.</span>transportLayer<span class="token punctuation">.</span><span class="token function">deleteTodo</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>store<span class="token punctuation">.</span><span class="token function">removeTodo</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    @computed <span class="token keyword">get</span> <span class="token function">asJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
            id<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>id<span class="token punctuation">,</span>
            completed<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>completed<span class="token punctuation">,</span>
            task<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>task<span class="token punctuation">,</span>
            authorId<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>author <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>author<span class="token punctuation">.</span>id <span class="token punctuation">:</span> <span class="token keyword">null</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/**
     * Update this todo with information from the server
     */</span>
    <span class="token function">updateFromJson</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// make sure our changes aren&apos;t send back to the server</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>autoSave <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>completed <span class="token operator">=</span> json<span class="token punctuation">.</span>completed<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>task <span class="token operator">=</span> json<span class="token punctuation">.</span>task<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>author <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>store<span class="token punctuation">.</span>authorStore<span class="token punctuation">.</span><span class="token function">resolveAuthor</span><span class="token punctuation">(</span>json<span class="token punctuation">.</span>authorId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>autoSave <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// clean up the observer</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">saveHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="pitfalls.html" class="navigation navigation-prev " aria-label="Previous page: 常见问题 & 最佳事件">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="actions.html" class="navigation navigation-next " aria-label="Next page: 创建（异步）actions">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"定义 stores","level":"1.9.2","depth":2,"next":{"title":"创建（异步）actions","level":"1.9.3","depth":2,"path":"best/actions.md","ref":"best/actions.md","articles":[]},"previous":{"title":"常见问题 & 最佳事件","level":"1.9.1","depth":2,"path":"best/pitfalls.md","ref":"best/pitfalls.md","articles":[]},"dir":"ltr"},"config":{"plugins":["disqus","github","editlink","prism","-highlight","baidu","splitter","sitemap"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"prism":{},"disqus":{"useIdentifier":false,"shortName":"webpack-handbook"},"github":{"url":"https://github.com/ityiquan/ityiquan.github.com"},"editlink":{"label":"编辑本页","multilingual":false,"base":"https://github.com/ityiquan/ityiquan.github.com"},"splitter":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"fontsettings":{"theme":"white","family":"sans","size":2},"sitemap":{"hostname":"http://zhaoda.net/"},"baidu":{"token":"a9787f0ab45d5e237bab522431d0a7ec"},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"前端知识点总结","language":"zh","gitbook":"*","description":"前端知识点总结"},"file":{"path":"best/store.md","mtime":"2017-11-22T07:48:37.000Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2017-11-22T08:14:43.676Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/URI.js/1.16.1/URI.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-disqus/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-github/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-editlink/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-baidu/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-splitter/splitter.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

